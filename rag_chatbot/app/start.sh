#!/bin/bash
set -e  # 에러 발생 시 스크립트 즉시 종료 (안전한 실행을 위해 사용)

# ---------------------------------------------------------
# Ollama 서버 실행 (백그라운드)
# - ollama serve : Ollama API 서버 실행
# - & : 백그라운드 실행
# - $! : 마지막으로 실행된 백그라운드 프로세스의 PID를 의미
#   → 나중에 wait로 이 프로세스를 따라가기 위해 저장
# ---------------------------------------------------------
ollama serve &
PID=$!

# ---------------------------------------------------------
# Ollama API 준비 상태 확인 (헬스체크 루프)
# - curl -s : 조용히 HTTP 요청 보내기
# - http://localhost:11434/api/tags : Ollama 상태 확인용 API
# - >/dev/null : 출력은 버림
# - until ... ; do ... done : 요청이 성공할 때까지 반복 실행
# ---------------------------------------------------------
until curl -s http://localhost:11434/api/tags >/dev/null; do
    echo "Waiting for Ollama..."
    sleep 2  # 2초 대기 후 재시도
done

# ---------------------------------------------------------
# 모델 생성 (최초 1회)
# - ollama create <모델이름> -f <Modelfile 경로>
#   → Modelfile을 읽어 모델 빌드/등록
# - || true : 이미 모델이 존재하면 에러가 발생해도 무시하고 계속 진행
#   (set -e 옵션 때문에 반드시 필요)
# ---------------------------------------------------------
ollama create ko-llama-8B -f /root/.ollama/Modelfile || true

# ---------------------------------------------------------
# Ollama 서버를 포그라운드로 유지
# - wait <PID> : 앞서 실행한 Ollama 서버 프로세스가 종료될 때까지 기다림
# - 컨테이너의 메인 프로세스가 Ollama 서버가 되도록 보장
# ---------------------------------------------------------
wait $PID
